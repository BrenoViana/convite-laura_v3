name: Backup RSVP (CSV/JSON)

on:
  schedule:
    # 06:00 UTC ≈ 03:00 America/Sao_Paulo
    - cron: "0 6 * * *"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: rsvp-backup
  cancel-in-progress: false

jobs:
  backup:
    runs-on: ubuntu-latest
    env:
      BASE_URL: https://laura.alves.tec.br/api/rsvp
      TZ: America/Sao_Paulo
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Mascarar token em logs
        run: echo "::add-mask::${{ secrets.ADMIN_TOKEN }}"

      - name: Criar pasta de backups
        run: mkdir -p backups/rsvp

      - name: Baixar CSV e JSON
        shell: bash
        run: |
          set -Eeuo pipefail
          DS=$(TZ="$TZ" date +%F)
          H="Authorization: Bearer ${{ secrets.ADMIN_TOKEN }}"

          curl -sS -H "$H" "$BASE_URL?list=1" > "backups/rsvp/rsvp-$DS.json"
          curl -sS -H "$H" "$BASE_URL/export?format=json" > "backups/rsvp/rsvp-$DS.export.json"
          curl -sS -H "$H" "$BASE_URL/export?format=csv"  -o "backups/rsvp/rsvp-$DS.csv"

          cp "backups/rsvp/rsvp-$DS.json"  "backups/rsvp/latest.json"
          cp "backups/rsvp/rsvp-$DS.csv"   "backups/rsvp/latest.csv"

      - name: (Opcional) Expurgar arquivos >180 dias
        shell: bash
        run: |
          find backups/rsvp -type f -name 'rsvp-*.json' -mtime +180 -delete || true
          find backups/rsvp -type f -name 'rsvp-*.csv'  -mtime +180 -delete || true
          true

      - name: Commit & push
        shell: bash
        run: |
          set -Eeuo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add backups/rsvp || true
          git commit -m "chore(backup): RSVP $(TZ="$TZ" date '+%F %T %Z')" || echo "Sem mudanças"
          git push || true
