<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>RSVP • Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--ink:#e9e9f2;--panel:#12121b;--muted:#9aa0a6;--danger:#ff6b6b;--ok:#4caf50;--accent:#d95679}
    html,body{height:100%}
    body{margin:0;background:#0d0d12;color:var(--ink);font:14px/1.4 system-ui,Segoe UI,Roboto}
    .wrap{max-width:1000px;margin:34px auto;padding:0 18px}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.4);padding:22px}
    h1{margin:0 0 6px}
    .hint{color:var(--muted);margin-bottom:16px}
    input[type="password"],input[type="text"]{width:100%;max-width:460px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0e0e15;color:#fff;padding:10px 12px}
    .row{display:flex;gap:10px;align-items:center;margin:10px 0 18px}
    .btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn.p{background:var(--accent);color:white}
    .btn.o{background:transparent;color:var(--ink);border:1px solid rgba(255,255,255,.18)}
    .btn.d{background:var(--danger);color:#fff;margin-left:auto}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border-top:1px solid rgba(255,255,255,.08);padding:10px}
    th{font-weight:600;text-align:left;color:#d6d6e2;background:rgba(255,255,255,.02)}
    .stats{margin:6px 0 10px;color:#cfd3da}
    .kids{color:#cdd}
    .ok{color:var(--ok)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Lista de Presença – Admin (uso local)</h1>
      <p class="hint">Seu token <strong>ADMIN_TOKEN</strong> não é enviado a lugar nenhum além da chamada à API. Ele é salvo no <em>localStorage</em> deste navegador.</p>

      <div class="row">
        <input id="tok" type="password" placeholder="Cole o ADMIN_TOKEN…" />
        <button class="btn p" id="load">Carregar lista</button>
        <button class="btn o" id="csv">Baixar CSV</button>
        <button class="btn o" id="json">Baixar JSON</button>
        <button class="btn d" id="clear">Limpar tudo</button>
      </div>

      <div id="stats" class="stats">—</div>

      <table id="tbl">
        <thead>
          <tr>
            <th>Data/Hora</th><th>Nome</th><th>Presença</th>
            <th>Adultos</th><th>Acomp.</th><th>Crianças</th>
            <th>Telefone</th><th>Mensagem</th><th>IP</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
const $ = s => document.querySelector(s);
const tok = $('#tok'); const stats = $('#stats');
const body = $('#tbl tbody');

(function init(){
  const saved = localStorage.getItem('RSVP_ADMIN_TOKEN');
  if(saved) tok.value = saved;
})();
function hdr(){ return { 'Authorization':'Bearer '+tok.value }; }
function saveTok(){ localStorage.setItem('RSVP_ADMIN_TOKEN', tok.value.trim()); }

function fmtKids(rec){
  if (Array.isArray(rec.kids) && rec.kids.length){
    return rec.kids.map(k => `${k.name} (${k.age})`).join(', ');
  }
  if (typeof rec.childrenCount === 'number') return String(rec.childrenCount);
  if (typeof rec.children === 'number') return String(rec.children);
  return '';
}
function tr(rec){
  const d = new Date(rec.ts);
  return `<tr>
    <td>${d.toLocaleString('pt-BR')}</td>
    <td>${rec.name||''}</td>
    <td>${rec.attending?'Sim':'Não'}</td>
    <td>${rec.adults||0}</td>
    <td>${rec.hasCompanion?(rec.companionName||'Sim'):''}</td>
    <td class="kids">${fmtKids(rec)}</td>
    <td>${rec.phone||''}</td>
    <td>${rec.message||''}</td>
    <td>${rec.ip||''}</td>
  </tr>`;
}

async function load(){
  saveTok();
  body.innerHTML = '';
  stats.textContent = 'Carregando…';
  const r = await fetch('/api/rsvp?list=1', { headers: hdr() });
  if(!r.ok){ stats.textContent = 'Erro ao carregar ('+r.status+')'; return; }
  const arr = await r.json();
  let presentes=0, ad=0, ch=0;
  for(const rec of arr){
    if(rec.attending){ presentes++; ad += Number(rec.adults||0); ch += (Number(rec.childrenCount||rec.children||0)); }
    body.insertAdjacentHTML('beforeend', tr(rec));
  }
  stats.textContent = `Registros: ${arr.length} • Presentes: ${presentes} • Adultos: ${ad} • Crianças: ${ch}`;
}

async function dl(kind){
  saveTok();
  const r = await fetch('/api/rsvp/export?format='+kind, { headers: hdr() });
  if(!r.ok){ alert('Falha ('+r.status+')'); return; }
  const blob = await r.blob();
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'rsvp-'+new Date().toISOString().slice(0,10)+'.'+kind;
  a.click();
  URL.revokeObjectURL(a.href);
}

async function clearAll(){
  if(!confirm('Tem certeza? Isso apaga tudo.')) return;
  saveTok();
  const r = await fetch('/api/rsvp/clear?confirm=YES', { method:'POST', headers: hdr() });
  if(!r.ok){ alert('Falha ('+r.status+')'); return; }
  await load();
}

$('#load').onclick = load;
$('#csv').onclick = () => dl('csv');
$('#json').onclick = () => dl('json');
$('#clear').onclick = clearAll;
</script>
</body>
</html>
